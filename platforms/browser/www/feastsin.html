<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
        <meta name="msapplication-tap-highlight" content="no" />
        <meta name="format-detection" content="telephone=no" />
        <title>Martlapp</title>
        <link rel="stylesheet" type="text/css" href="fonts.css">
        <link rel="stylesheet" type="text/css" href="css/style.css">
    </head>
    <body>
        <div class="header"><a href="feasts.html" class="back"><img src="images/back.png" class="ukan"> უკან</a> <button id="calendar"><img src="images/calendar.png"></button></div>

        <div id="afterclickoncalendar">
            <div class="month">
                <button class="prev"><img src="images/monthprev.png"></button>
                <h3 class="monthtitle"></h3>
                <button class="next"><img src="images/monthnext.png"></button>
            </div>
            <table id="cal"></table>
            <div id="color" class="colors"></div>
        </div>        

        <div id="feast">
          
        </div>
        <script src="js/jquery-3.3.1.min.js"></script>
        <script>
            var marxvebi;
            var feasts;
            $.ajax({
                    url: 'http://martlapi.testme.ge/api/v1/calendar',
                    success: function(res){
                        marxvebi = res.markhva;
                        feasts = res.feasts;
                        getColors(res.colors);
                        console.log(res);
                    }
                });
            var monthnum = new Date().getMonth();
            function calendar(month){
                var tempDate = new Date();
                var months = ['იანვარი','თებერვალი','მარტი','აპრილი','მაისი','ივნისი','ივლისი','აგვისტო','სექტემბერი','ოქტომბერი','ნოემბერი','დეკემბერი'];
                 var date = (month != undefined) ? new Date(tempDate.getFullYear(), month, tempDate.getDate()) : new Date();
                 var lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
                var firdaypad = new Date(date.getFullYear(), date.getMonth(), 1).getDay();
                var prevMonthLastDay = new Date(date.getFullYear(), date.getMonth(), 0).getDate();
                var marxvisDgeebi = [];
                marxvebi.forEach(function(marxva){
                                    var dates = getDates(new Date(marxva.start_date), new Date(marxva.end_date), marxva);
                                    marxvisDgeebi = marxvisDgeebi.concat(dates);
                                });
                if(marxvebi && feasts){
                    $(".monthtitle").html(months[date.getMonth()]);
                    var calendarhtml = "<tr class='tableheader'><th>ორშ</th><th>სამ</th><th>ოთხ</th><th>ხუთ</th><th>პარ</th><th>შაბ</th><th>კვ</th></tr><tr>";
                    for(i=0; i<lastDay + firdaypad; i++){

                        if(i > 0 && i % 7 == 0){
                            calendarhtml+="</tr><tr>";
                        }

                        if(i >= firdaypad){
                                var d = false;
                                var d2 = false;
                                var currentDay = new Date(date.getFullYear(),date.getMonth(),cday);
                                marxvisDgeebi.forEach(function(obj){
                                    if(obj.day.getDate() == currentDay.getDate() && obj.day.getMonth() == currentDay.getMonth()){
                                        d = obj;
                                    }
                                });

                                feasts.forEach(function(feast){
                                    var feastDay = new Date(feast.date);
                                    if(feastDay.getDate() == currentDay.getDate() && feastDay.getMonth() == currentDay.getMonth()){
                                        d2 = feast;
                                    }
                                });
                            var cday = (i-firdaypad + 1);
                            if(cday == date.getDate() && date.getMonth() == tempDate.getMonth()){
                                if(d2 && cday == parseInt(d2.date.split('-')[2])){
                                    calendarhtml+="<td class='marxva' title='"+d2.title+"'><span class='tooltip' style='background-color: #"+d2.code+"'>"+d2.title+"</span><span class='bgcolor' style='background-color: #"+d2.code+"'><span class='before' style='border-top-color: #"+d2.code+"'></span>"+cday+"</span></td>";
                                    
                                }
                                else if(d && cday == d.day.getDate() + 1){
                                    calendarhtml+="<td class='currentDay' ><span class='tooltip' style='background-color: #"+d.color+"'>"+d.title+"</span><span class='bgcolor' style='background-color: #"+d.color+"'><span class='before' style='border-top-color: #"+d.color+"'></span>"+cday+"</span></td>";
                                }else{
                                    calendarhtml+="<td class='currentDay'>"+cday+"</td>";
                                }
                            }else{
                                if(d2){
                                    calendarhtml+="<td class='marxva' title='"+d2.title+"'><span class='tooltip' style='background-color: #"+d2.code+"'>"+d2.title+"</span><span class='bgcolor' style='background-color: #"+d2.code+"'><span class='before' style='border-top-color: #"+d2.code+"'></span>"+cday+"</span></td>";
                                }else if(d){
                                    calendarhtml+="<td class='marxva' title='"+d.title+"'><span class='tooltip' style='background-color: #"+d.color+"'>"+d.title+"</span><span class='bgcolor' style='background-color: #"+d.color+"'><span class='before' style='border-top-color: #"+d.color+"'></span>"+cday+"</span></td>";
                                }
                                else{
                                    calendarhtml+="<td>"+cday+"</td>";
                                }

                            }
                        }else{
                            calendarhtml+="<td class='gap'>"+(prevMonthLastDay - (firdaypad - 1) + i)+"</td>";
                        }

                        if((firdaypad + lastDay) % 7 != 0 && (i-firdaypad + 1)  == lastDay){
                            for(j = 0; j<7 - (firdaypad + lastDay)%7; j++){
                                calendarhtml+="<td class='gap'>"+(j+1)+"</td>";
                            }
                        }
                    }
                    calendarhtml+="</tr>";
                    $("#cal").html(calendarhtml);
                }
            }

            var getDates = function(startDate, endDate, obj) {
              var dates = [],
                  currentDate = startDate,
                  addDays = function(days) {
                    var date = new Date(this.valueOf());
                    date.setDate(date.getDate() + days);
                    return date;
                  };
              while (currentDate <= endDate) {
                var nobj = { day: currentDate, title: obj.title, color: obj.color_code};
                dates.push(nobj);
                currentDate = addDays.call(currentDate, 1);
              }
              return dates;
            };



            $().ready(function(){
                $(".prev").click(function(){
                    $(".next").removeClass('disabled');
                    if(monthnum > 1){
                        $(".prev").removeClass('disabled');
                        monthnum--;
                    }else if(monthnum == 1){
                        $(".prev").addClass('disabled');
                        monthnum--;
                    }else if(monthnum == 0){
                        $(".prev").addClass('disabled');
                    }
                    calendar(monthnum);
                    $("td").on('touchstart',function(){
                       var tooltipWidth = $(this).find('.tooltip').innerWidth();
                        $(this).find('.tooltip').width($(window).innerWidth() - 100);
                        $(this).find('.tooltip').css('left',-$(this).offset().left + 40)
                    });
                });

                $(".next").click(function(){
                    $(".prev").removeClass('disabled');
                    if(monthnum < 11){
                        monthnum++;
                        $(".next").removeClass('disabled');
                    }else if(monthnum == 11){
                            monthnum++;
                         $(".next").addClass('disabled');
                    }
                    calendar(monthnum);
                    $("td").on('touchstart',function(){
                       var tooltipWidth = $(this).find('.tooltip').innerWidth();
                        $(this).find('.tooltip').width($(window).innerWidth() - 100);
                        $(this).find('.tooltip').css('left',-$(this).offset().left + 40)
                    });
                });

            });

        var id = location.href.split('=')[1];
          $.ajax({url: "http://martlapi.testme.ge/api/v1/feasts/" + id, success: function(result){
            var html = '<h2>'+result.title+'</h2>';
            html += '<p>'+result.description+'</p>'
            $("#feast").html(html);
            console.log(result);
          }});

          $("#calendar").click(function(){
                calendar(monthnum);
                $("td").on('touchstart',function(){
                   var tooltipWidth = $(this).find('.tooltip').innerWidth();
                    $(this).find('.tooltip').width($(window).innerWidth() - 100);
                    $(this).find('.tooltip').css('left',-$(this).offset().left + 40)
                });
                $("body").toggleClass('calendar');
                if($("body").hasClass('calendar')){
                    $(".header").addClass('calendar');
                    $(".header #calendar img").attr('src','images/calendarred.png');
                }
                else{
                    $(".header").removeClass('calendar');
                    $(".header #calendar img").attr('src','images/calendar.png');
                }
            });

            function getCalendarByColor(){
                $("#colors li").on('click',function(){
                    var marxvaStart = $(this).data('marxvastart').length > 0 ? parseInt($(this).data('marxvastart').split('-')[1]) : false;
                    // var marxvaEnd = $(this).data('marxvaend').length > 0 ? parseInt($(this).data('marxvaend').split('-')[1]) : false;
                    var feast = $(this).data('feast').length > 0 ? parseInt($(this).data('feast').split('-')[1]) : false;

                    if(feast){
                        monthnum = feast - 1;
                        calendar(monthnum);
                    }else if(marxvaStart){
                        monthnum = marxvaStart - 1;
                        calendar(monthnum);
                    }
                    $("td").on('touchstart',function(){
                       var tooltipWidth = $(this).find('.tooltip').innerWidth();
                        $(this).find('.tooltip').width($(window).innerWidth() - 100);
                        $(this).find('.tooltip').css('left',-$(this).offset().left + 40)
                    });
                });
            }

            function getColors(colors){
                var html = '<ul id="colors">';

                colors.forEach(function(color){
                    html+='<li data-marxvastart="'+color.markhva_start+'" data-marxvaend="'+color.markhva_end+'" data-feast="'+color.feast+'"><div class="color" style="background-color: #'+color.code+'"></div> <h4>'+ color.title +'</h4></li>';
                });

                html+='</ul>';
                $("#color").html(html);
                getCalendarByColor();
            }
        </script>
    </body>
</html>
